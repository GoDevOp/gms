[% matches = content.match ('(\<form .*\>)', 1) -%]
[% IF matches %]
    [% FOREACH match IN matches %]
        [% content = content.replace (match,match _ '<input type="hidden" name="_token" id="token" value="' _ c.controller.token(c) _ '" />' ); %]
    [% END %]
[%END -%]
[% IF (!c.request.param ('ajax')) -%]
    <?xml version="1.0" encoding="UTF-8" ?>
    <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.4//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
    <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="de">
      <head>
        <title>Freenode Group Management System</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="[% c.uri_for('/static/css/bootstrap.min.css') %]" />
        <link rel="stylesheet" type="text/css" href="[% c.uri_for('/static/css/main.css') %]" />
        <script type="text/javascript">
            document.root_url = "[% c.uri_for ('/') | html %]";
        </script>
        <script type="text/javascript" src="[% c.uri_for('/static/js/format.js') %]"></script>
        <script type="text/javascript" src="[% c.uri_for('/static/js/constants.js') %]"></script>
        <script type="text/javascript" src="[% c.uri_for('/static/js/json.min.js') %]"></script>
        <script type="text/javascript" src="[% c.uri_for('/static/js/main.js') %]"></script>
      </head>
      <body>
        <div id="header">
          <div class="logo">
            <img src="[% c.uri_for('/static/img/freenode_logo.png') %]" width="340" height="68" />
          </div>
          <div class="login">
              [% IF c.user_exists -%]
              You are logged in as [% c.user.username | html %]
              (<a href="[% c.uri_for('/logout') %]">log out</a>).
              [% ELSE -%]
              You are not logged in
              (<a href="[% c.uri_for('/login') %]">log in</a>).
              [% END %]
          </div>
        </div><!-- header end -->
        <div id="sidebar">
          <div><!-- links -->
            <a href="http://freenode.net/">Freenode Main Page</a>
            <br />
            <a href="[% c.uri_for('/') %]">GMS Home</a>
          </div>
          <div>
              <ul class="nolist">
                  [% IF  c.check_user_roles('admin')  %]
                  <li><a href="[% c.uri_for('/admin/') %]">Admin</a></li>
                  [% ELSIF c.check_user_roles ('staff') %]
                  <li><a href="[% c.uri_for('/staff/') %]">Staff</a></li>
                  [% END %]
                  <li><a href="[% c.uri_for('/group/') %]">Your groups</a></li>
                  <li><a href="[% c.uri_for('/userinfo') %]">Your contact info</a></li>
                  <li><a href="[% c.uri_for('/cloak') %]">Your pending group cloaks</a></li>
                  <li><a href="[% c.uri_for('/group/new') %]">Register a new group</a></li>
              </ul>
          </div>
        </div><!-- sidebar end -->
        <div id="main">
          <!-- error box -->

          <div id="error_container" class="alert alert-error [% IF !error_msg %] hidden [% END %]">
            [% error_msg | html %]
          </div>

          [% IF errors %]
          <div class="alert alert-error">
              <p> The following errors were encountered:</p>
              <ul>
                  [% FOREACH error IN errors %]
                  <li> [% error | html %] </li>
                  [% END %]
              </ul>
          </div>
          [% END %]
          <!-- status box -->
          [% IF status_msg %]
          <div class="alert alert-info">
            [% status_msg | html %]
          </div>
          [% END %]
          <!-- content box -->
          <div class="content">
            [% content %]
          </div>
        </div><!-- main end -->
        <div id="footer">
        </div><!-- footer end -->
      </body>
    </html>
[% ELSE -%]
   <!--
      Very minimal page shown if 'ajax' is set in the POST body,
      which it will be if we're loading it though an AJAX request.
      The page shows the error/status message and the content.
      The ajax result will be loaded into another, already-existing
      HTML element, so we don't need to (and shoudln't) output full
      HTML code.
   -->
   [% IF error_msg %]
      <div class="alert alert-error">
        [% error_msg | html %]
      </div>
  [% END %]
  [% IF errors %]
      <div class="alert alert-error">
        <p> The following errors were encountered:</p>
        <ul>
          [% FOREACH error IN errors %]
          <li> [% error | html %] </li>
          [% END %]
        </ul>
      </div>
  [% END %]
  [% IF status_msg %]
      <div class="alert alert-info">
        [% status_msg | html %]
      </div>
  [% END %]

  [% content %]

[% END -%]
